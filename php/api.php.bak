<?php
// Debug temporaneo
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');

try {
    // Verifica se config.php esiste
    if (!file_exists('config.php')) {
        throw new Exception('File config.php non trovato');
    }
    
    require_once 'config.php';
    
    // Verifica se le funzioni esistono
    if (!function_exists('getConnection')) {
        throw new Exception('Funzione getConnection non definita in config.php');
    }
    
    if (!function_exists('sendJsonResponse')) {
        throw new Exception('Funzione sendJsonResponse non definita in config.php');
    }
    
    // Test connessione database
    error_log("DEBUG: Tentativo di connessione al database");
    $conn = getConnection();
    error_log("DEBUG: Connessione al database stabilita");
    
    $action = isset($_GET['action']) ? $_GET['action'] : '';
    
    if ($action === 'getData') {
        error_log("DEBUG: Esecuzione getData");
        try {
            $stmt = $conn->query("SELECT id, codice, categoria, tipo, marca, ubicazione, doc, note FROM attrezzature ORDER BY codice");
            if (!$stmt) {
                error_log("DEBUG: Errore nella query - " . print_r($conn->errorInfo(), true));
                throw new Exception("Errore nella query: " . implode(" ", $conn->errorInfo()));
            }
            $data = $stmt->fetchAll(PDO::FETCH_ASSOC);
            error_log("DEBUG: Query eseguita con successo, trovati " . count($data) . " record");
            // Log chiamata API su LogEvent
            if (function_exists('logApiEvent')) {
                logApiEvent($conn, 'getData', $_GET, 200, ['count' => count($data)], null);
            }
            echo json_encode([
                'success' => true,
                'message' => 'Test completato con successo',
                'count' => count($data),
                'data' => $data
            ]);
        } catch (Exception $e) {
            if (function_exists('logApiEvent')) {
                logApiEvent($conn, 'getData', $_GET, 500, null, $e->getMessage());
            }
            http_response_code(500);
            echo json_encode([
                'success' => false,
                'message' => 'Errore durante il recupero dei dati: ' . $e->getMessage()
            ]);
        }
    } else {
        if (function_exists('logApiEvent')) {
            logApiEvent($conn, $action ?: 'unknown', $_GET, 400, null, 'Azione non specificata');
        }
        echo json_encode([
            'success' => false,
            'message' => 'Azione non specificata. Usa ?action=getData'
        ]);
    }
    
} catch(Exception $e) {
    // Log dettagliato dell'errore
    error_log("ERRORE API: " . $e->getMessage() . "\n" .
              "File: " . $e->getFile() . "\n" .
              "Line: " . $e->getLine() . "\n" .
              "Stack trace: " . $e->getTraceAsString());

    http_response_code(500);
    echo json_encode([
        'success' => false,
        'error' => $e->getMessage(),
        'file' => $e->getFile(),
        'line' => $e->getLine(),
        'trace' => $e->getTraceAsString()
    ]);
}
?>
